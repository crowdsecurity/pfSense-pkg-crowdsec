<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE packagegui SYSTEM "../schema/packages.dtd">
<?xml-stylesheet type="text/xsl" href="../xsl/package.xsl"?>
<packagegui>
    <copyright>
        <![CDATA[
/*
 * crowdsec.xml
 *
 * Copyright (c) 2020-2023 Crowdsec
 * All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
	]]>
    </copyright>
    <name>CrowdSec</name>
    <title>Security/CrowdSec</title>
    <include_file>/usr/local/pkg/crowdsec.inc</include_file>
    <menu>
        <name>CrowdSec</name>
        <section>Services</section>
        <url>/crowdsec/landing.php</url>
    </menu>
    <service>
        <name>crowdsec</name>
        <rcfile>pfsense_crowdsec</rcfile>
        <description>Crowdsec service</description>
    </service>
    <tabs>
        <tab>
            <text>CrowdSec</text>
            <url>/crowdsec/landing.php</url>
        </tab>
        <tab>
            <text>Settings</text>
            <url>/pkg_edit.php?xml=crowdsec.xml</url>
            <active/>
        </tab>
        <tab>
            <text>Status</text>
            <url>/crowdsec/status.php</url>
        </tab>
        <tab>
            <text>Metrics</text>
            <url>/crowdsec/metrics.php</url>
        </tab>
    </tabs>
    <fields>
        <field>
            <name>Log processor (CrowdSec agent)</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr>Enable</fielddescr>
            <fieldname>enable_agent</fieldname>
            <type>checkbox</type>
            <default_value>on</default_value>
        </field>
        <field>
            <fielddescr></fielddescr>
            <fieldname>agent_info</fieldname>
            <type>info</type>
            <description>Read logs from pfSense and its packages to detect threats. Recommended.</description>
        </field>

        <field>
            <name>Remediation component (firewall bouncer)</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr>Enable</fielddescr>
            <fieldname>enable_fw_bouncer</fieldname>
            <type>checkbox</type>
            <default_value>on</default_value>
        </field>
        <field>
            <fielddescr></fielddescr>
            <fieldname>firewall_info</fieldname>
            <type>info</type>
            <description>Add the malevolent IPs detected by the log processor or from the community/third party blocklists to the pfSense firewall. Recommended.</description>
        </field>

        <field>
            <name>Local API</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr>Enable</fielddescr>
            <fieldname>enable_lapi</fieldname>
            <description>Enable a local API on the pfSense box. If disabled, use a remote LAPI on an external machine.</description>
            <type>checkbox</type>
            <default_value>on</default_value>
        </field>
        <field>
            <fielddescr>LAPI host</fielddescr>
            <fieldname>lapi_host</fieldname>
            <type>input</type>
            <description>Host name or IP. Change this to expose the LAPI to the LAN, or to use an external LAPI. For example you can have one or more servers running only the Log Processor (agent) which report to the LAPI in this pfSense machine. Otherwise, leave the default value (127.0.0.1).</description>
            <default_value>127.0.0.1</default_value>
        </field>
        <field>
            <fielddescr>LAPI port</fielddescr>
            <fieldname>lapi_port</fieldname>
            <type>input</type>
            <description>Port number for the LAPI endpoint. Change in case of conflict with other services.</description>
            <default_value>8080</default_value>
        </field>
        <field>
            <name>Remote LAPI</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr></fielddescr>
            <fieldname>remote_lapi_info</fieldname>
            <type>info</type>
            <description><![CDATA[You will need to register the log processor and the bouncer in the LAPI machine, then report here their connection credentials.<br/><br/>Recommended if:<br/><ul><li>you have a pre-existing installation, maybe running on linux</li><li>you want more control over the configuration, backup/restore, need a bigger machine or a postgres database</li><li>you want more control over the running versions or want to run it on docker, k8s</li></ul><p>To retrieve the connection credentials, run the following commands on the remote machine:</p><pre># cscli machines add pfsense --auto -f -</pre><p>and</p><pre># cscli bouncers add pfsense-firewall</pre>]]></description>
        </field>
        <field>
            <fielddescr>Remote LAPI host</fielddescr>
            <fieldname>remote_lapi_host</fieldname>
            <type>input</type>
            <description>Host name or IP. Change this to expose the LAPI to the LAN, or to use an external LAPI. For example you can have one or more servers running only the Log Processor (agent) which report to the LAPI in this pfSense machine. Otherwise, leave the default value (127.0.0.1).</description>
        </field>
        <field>
            <fielddescr>Remote LAPI port</fielddescr>
            <fieldname>remote_lapi_port</fieldname>
            <type>input</type>
            <description>Port number for the LAPI endpoint. Change in case of conflict with other services.</description>
            <default_value>8080</default_value>
        </field>
        <field>
            <fielddescr>User</fielddescr>
            <fieldname>remote_agent_user</fieldname>
            <type>input</type>
            <description>Name of this machine in the remote LAPI</description>
        </field>
        <field>
            <fielddescr>Password</fielddescr>
            <fieldname>remote_agent_password</fieldname>
            <type>password</type>
            <description>Password of this machine in the remote LAPI</description>
        </field>
        <field>
            <fielddescr>Firewall bouncer API key</fielddescr>
            <fieldname>remote_fw_bouncer_api_key</fieldname>
            <type>password</type>
            <description>API key of this bouncer in the remote LAPI</description>
        </field>
        <field>
            <name>Log level</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr>crowdsec</fielddescr>
            <fieldname>agent_log_level</fieldname>
            <description>crowdsec.log, crowdsec_api.log</description>
            <type>select</type>
            <options>
                <option><name>Debug</name><value>debug</value></option>
                <option><name>Info</name><value>info</value></option>
                <option><name>Warning</name><value>warning</value></option>
            </options>
            <default_value>info</default_value>
            <required>true</required>
        </field>
        <field>
            <fielddescr>firewall bouncer</fielddescr>
            <fieldname>firewall_bouncer_log_level</fieldname>
            <description>crowdsec-firewall-bouncer.log</description>
            <type>select</type>
            <options>
                <option><name>Debug</name><value>debug</value></option>
                <option><name>Info</name><value>info</value></option>
                <option><name>Warning</name><value>warning</value></option>
            </options>
            <default_value>info</default_value>
            <required>true</required>
        </field>
        <field>
            <name>Metrics</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr></fielddescr>
            <fieldname>metrics_info</fieldname>
            <type>info</type>
            <description>Where to expose metrics that can be consumed for monitoring (prometheus, grafana etc.). Change in case of conflict.</description>
        </field>
        <field>
            <fielddescr>Port (crowdsec)</fielddescr>
            <fieldname>metrics_port</fieldname>
            <type>input</type>
            <required>true</required>
            <default_value>6060</default_value>
        </field>

        <!-- Crowdsec IPv4 blocklist settings -->
        <field>
            <name>CrowdSec IPv4 blocklist rule settings</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr></fielddescr>
            <fieldname>block_v4_info</fieldname>
            <type>info</type>
            <description><![CDATA[Add a pfctl rule: <i>block drop {direction} {log} quick inet from crowdsec_blacklists to any label "CrowdSec IPv4" tag {tag}</i>.<br/>The rule will be hidden in the pfSense UI.]]></description>
        </field>
        <field>
            <fielddescr>Enable CrowdSec IPv4 blocklist rule</fielddescr>
            <fieldname>enable_block_v4</fieldname>
            <default_value>on</default_value>
            <type>checkbox</type>
            <enablefields>block_v4_direction,block_v4_log,block_v4_tag</enablefields>
        </field>
        <field>
            <fielddescr>Direction</fielddescr>
            <fieldname>block_v4_direction</fieldname>
            <description></description>
            <type>select</type>
            <options>
                <option><name>Any (inbound + outbound)</name><value>any</value></option>
                <option><name>In (inbound)</name><value>in</value></option>
            </options>
            <default_value>any</default_value>
        </field>
        <field>
            <fielddescr>Log</fielddescr>
            <fieldname>block_v4_log</fieldname>
            <type>checkbox</type>
        </field>
        <field>
            <fielddescr>Tag</fielddescr>
            <fieldname>block_v4_tag</fieldname>
            <type>input</type>
            <description></description>
        </field>
        <!-- Crowdsec IPv6 blocklist settings -->
        <field>
            <name>CrowdSec IPv6 blocklist rule settings</name>
            <type>listtopic</type>
        </field>
        <field>
            <fielddescr></fielddescr>
            <fieldname>block_v6_info</fieldname>
            <type>info</type>
            <description><![CDATA[Add a pfctl rule: <i>block drop {direction} {log} quick inet6 from crowdsec6_blacklists to any label "CrowdSec IPv6" tag {tag}</i>.<br/>The rule will be hidden in the pfSense UI.]]></description>
        </field>
        <field>
            <fielddescr>Enable CrowdSec IPv6 blocklist rule</fielddescr>
            <fieldname>enable_block_v6</fieldname>
            <default_value>on</default_value>
            <type>checkbox</type>
            <enablefields>block_v6_direction,block_v6_log,block_v6_tag</enablefields>
        </field>
        <field>
            <fielddescr>Direction</fielddescr>
            <fieldname>block_v6_direction</fieldname>
            <type>select</type>
            <options>
                <option><name>Any (inbound + outbound)</name><value>any</value></option>
                <option><name>In (inbound)</name><value>in</value></option>
            </options>
            <default_value>any</default_value>
        </field>
        <field>
            <fielddescr>Log</fielddescr>
            <fieldname>block_v6_log</fieldname>
            <type>checkbox</type>
        </field>
        <field>
            <fielddescr>Tag</fielddescr>
            <fieldname>block_v6_tag</fieldname>
            <type>input</type>
            <description></description>
        </field>
    </fields>

    <custom_php_install_command>
        <![CDATA[
		crowdsec_install();
		]]>
    </custom_php_install_command>

    <custom_php_resync_config_command>
        <![CDATA[
		crowdsec_resync_config();
		]]>
    </custom_php_resync_config_command>

    <custom_php_validation_command>
        <![CDATA[
        crowdsec_validate_form($_POST, $input_errors);
        ]]>
    </custom_php_validation_command>

    <custom_php_pre_deinstall_command>
        <![CDATA[
		crowdsec_deinstall();
		]]>
    </custom_php_pre_deinstall_command>

    <filter_rules_needed><![CDATA[crowdsec_generate_rules]]></filter_rules_needed>

    <custom_php_after_form_command>crowdsec_after_form();</custom_php_after_form_command>

    <custom_php_after_head_command><![CDATA[crowdsec_after_head();]]></custom_php_after_head_command>

    <!--
    <custom_add_php_command></custom_add_php_command>
    <custom_add_php_command_late></custom_add_php_command_late>
    <custom_php_global_functions></custom_php_global_functions>
    <custom_php_deinstall_command></custom_php_deinstall_command>
    <custom_delete_php_command></custom_delete_php_command>
    <start_command></start_command>
    <custom_php_service_status_command></custom_php_service_status_command>
    <custom_php_command_before_form></custom_php_command_before_form>
    -->
</packagegui>

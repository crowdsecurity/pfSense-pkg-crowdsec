<style type="text/css">
#introduction a.btn-info {
  color: black;
  margin: 3px;
}

.tab-pane {
  margin: 10px;
}
</style>

<div class="content-box tab-content">
    <div id="introduction" class="tab-pane fade in active">
        <h2>Configuration</h2>

        <div class="alert alert-info">
           <p>
               Do not use the shell commands <code>sysrc</code> or <code>service</code> to enable and start the crowdsec services,
               it is not required with pfSense. Do not create a <code>pf.conf</code> file.
           </p>
           <p>
               <b>RAM disk</b>: before running CrowdSec, ensure that you are <a href="https://docs.netgate.com/pfsense/en/latest/config/advanced-misc.html#ram-disk-settings">not using a RAM disk</a>
               for the /var directory. The persistent CrowdSec database and GeoIP tables are in /var/db.
               If you really need a RAM disk, you can still do log processing and remediation but you will
               need to connect to a remote LAPI.
           </p>
           <p>
               <b>Backup</b>: for the same reasons, the CrowdSec set-up is not transferred when you restore a pfSense backup, and you'll need to reconfigure it
               or backup separately.
           </p>
        </div>

        <p>
            If you are reading this on your pfSense machine, a CrowdSec <a href="https://doc.crowdsec.net/docs/next/getting_started/security_engine_intro">Security Engine</a>
            (threat detection) and a <a href="https://docs.crowdsec.net/docs/bouncers/firewall/">Firewall remediation component</a> (bouncer) are already installed.
        </p>

        <p>
            Go to the <a href="/pkg_edit.php?xml=crowdsec.xml">Settings</a> tab. The <b>Log Processor</b>,
            <b>Remediation component</b> and <b>Local API</b> should be enabled. Click Save. If you
            already have a CrowdSec installation on another machine, you can connect the two by disabling Local API
            and filling the fields in the <b>Remote LAPI</b> section.
        </p>

        <p>
            CrowdSec on pfSense is fully functional from the command line but the web interface
            is read-only, with the exception of decision revocation (unban).
            Most actions require the shell or the <a href="https://app.crowdsec.net">CrowdSec Console</a>.
            For simple things, <a href="/diag_command.php">Diagnostics/Command Prompt</a> works as well as ssh.
            You are free to edit the files in <code>/usr/local/etc/crowdsec</code>, but some setting may be overwritten
            by the pfSense package as needed.
        </p>

        <p>
            The following scenarios are enabled by default:

            <ul>
                <li>portscan</li>
                <li>ssh brute-force</li>
                <li>pfSense admin brute-force</li>
            </ul>

            These will trigger a ban on the attacking IP (4 hours by default) and report it to the CrowdSec Central API
            (meaning <a href="https://docs.crowdsec.net/docs/concepts/">timestamp, scenario, attacking IP</a>), contributing to the
            Community Blocklist.
        </p>

        <p>
            You can add scenarios to detect other types of attack on the pfSense server, or connect
            <a href="https://doc.crowdsec.net/docs/next/user_guides/multiserver_setup">other CrowdSec log processors</a>
            to the same LAPI node. Other types of remediation are possible (ex. captcha test for scraping attempts).
        </p>

        <p>
            If disk space is not an issue, you can <a href="https://docs.netgate.com/pfsense/en/latest/monitoring/logs/size.html">increase the maximum size</a>
            of log files before they are compressed and rotated. This will help us in case you report some
            acquisition issue and we need to match the application behavior with the content of the acquired logs.
        </p>

        <p>
            We recommend you to <a href="https://app.crowdsec.net/">register to the Console</a>, especially if you protect several
            machines.
        </p>

        <p>
            Please refer to the <a href="https://crowdsec.net/blog/category/tutorial/">tutorials</a> to explore other possibilities.
        </p>

        <div>
            <a class="btn btn-default btn-info" href="https://doc.crowdsec.net/docs/intro">
                Documentation
            </a>
            <a class="btn btn-default btn-info" href="https://crowdsec.net/blog/">
                Blog
            </a>
            <a class="btn btn-default btn-info" href="https://app.crowdsec.net/">
                Console
            </a>
            <a class="btn btn-default btn-info" href="https://hub.crowdsec.net/">
                CrowdSec Hub
            </a>
        </div>

        <h3>Status tab</h3>

        <p>In the <a href="/crowdsec/status.php">Status</a> tab, you can see</p>

        <ul>
            <li>Registered log processors and bouncers (at least one of each, running on pfSense)</li>
            <li>Installed hub items (collections, scenarios, parsers, postoverflows)</li>
            <li>Alerts and local decisions</li>
        </ul>

        <p>All tables are read-only with an exception: you can delete single decisions, to un-ban an IP for example.</p>

        <p>
            All hub items are periodically upgraded with a cron job.
        </p>

        <h3>Metrics tab</h3>

        <p>
            In the <a href="/crowdsec/metrics.php">Metrics</a> tab you can check if the logs are acquired and the
            events are triggered correctly. For real monitoring, you can fetch the same metrics with
            <a href="https://docs.crowdsec.net/docs/observability/prometheus/">Prometheus (Grafana dashboard included)</a>,
            Telegraf or your favorite solution.
        </p>

        <h3>Logs</h3>

        <p>
            You can see the Security Engine logs in <a href="/status_logs_packages.php?pkg=crowdsec">Status/System 
            Logs/Packages/crowdsec</a>.
            These are in <code>/var/log/crowdsec/crowdsec.log</code>.
            The logs for the LAPI and bouncer are not available from the UI, they are in <code>crowdsec_api.log</code> and <code>crowdsec-firewall-bouncer.log</code>.
        </p>

        <h3>Service management</h3>

        <p>
            Both services can be restarted from <a href="/status_services.php">Status/Services</a>.
            The equivalent shell commands are <code>service crowdsec.sh start/stop/restart</code> and <code>service crowdsec_firewall.sh start/stop/restart</code>,
            note the ending <code>.sh</code>.
            They can be run from <a href="/diag_command.php">Diagnostics/Command Prompt</a> as well as from ssh.
        </p>

        <h3>Viewing blocked IPs</h3>

        <p>
            You can see the tables of the blocked IPs in <a href="/diag_tables.php">Diagnostics/Tables</a> or from 
            the shell, with the commands
            <code>pfctl -T show -t crowdsec_blacklists</code> (IPv4) and <code>pfctl -T show -t crowdsec6_blacklists</code> (IPv6).
        </p>

        <p>
            To show the same data with more context, use <code>cscli decisions list -a</code>.
        </p>

        <h3>Adding data sources</h3>

        <p>
            If a collection, parser or scenario can be applied to a software that you are running on pfSense,
            you can add it with <code>cscli collections install ...</code> or an equivalent command, then
            you need to tell CrowdSec where to find the logs.
        </p>

        <p>
            New acquisition files should go under <code>/usr/local/etc/crowdsec/acquis.d/</code>. See <code>pfsense.yaml</code> for an example.
            The option <code>poll_without_inotify: true</code> is required if the log sources are symlinks.
            Remember to reload or restart CrowdSec when you add new data sources.
        </p>

        <h3>Testing</h3>

        <p>
            A quick way to test that everything is working correctly end-to-end is to
            execute the following command.
        </p>

        <p>
            Your ssh session should freeze and you should be kicked out from
            the firewall. You will not be able to connect to it (from the same
            IP address) for two minutes.
        </p>

        <p>
            It might be a good idea to have a secondary IP from which you can
            connect, should anything go wrong.
        </p>

        <p>
            You may have to disable the <b>Anti-lockout</b> rule in
            <a href="/system_advanced_admin.php">System/Advanced/Admin Access</a> for the
            time of the test.
	</p>

	<pre><code>[admin@pfSense.home.arpa]/root: cscli decisions add -t ban -d 2m -i &lt;your_ip_address&gt;</code></pre>

	<p>
	    This is a more secure way to test than attempting to brute-force
	    yourself: the default ban period is 4 hours, and Crowdsec reads the
	    logs from the beginning, so it could ban you even if you failed ssh
	    login 10 times in 30 seconds two hours before installing it.
	</p>

        <p>
            It must be noted that the <a href="https://docs.netgate.com/pfsense/en/latest/config/advanced-admin.html#login-protection">Login Protection</a>
            service which is enabled by default on pfSense can be triggered - and block a brute force attacker - before CrowdSec does,
            because it's more sensitive. Still, some attacks that are not detected by Login Protection will be detected by CrowdSec and shared.
            If you need more CrowdSec tests you may want to temporarily disable Login Protection, depending on the scenario.
        </p>

        <p>
            By default the FreeBSD version of CrowdSec does not install any whitelist.
            If you trust your <code>10.0.0.0/8</code>, <code>192.168.0.0/16</code> and <code>172.16.0.0/12</code>
            networks, you can use <code>cscli parsers install crowdsecurity/whitelists</code> to whitelist them.
        </p>

        <h3>Uninstalling</h3>

        <p>
            In most cases, just remove the <code>crowdsec</code> package from
            <a href="/pkg_mgr_installed.php">System/Package Manager/Installed Packages</a>.
            This won't remove the crowdsec database and configuration files, just in case
            you want to reinstall it later.
        </p>

        <p>
            If you need to make sure you removed all traces of CrowdSec, you can run the following commands:
        </p>

        <pre># pkg remove pfSense-pkg-crowdsec crowdsec crowdsec-firewall-bouncer
# rm -rf /usr/local/etc/crowdsec /usr/local/etc/rc.conf.d/crowdsec*
# rm -rf /var/db/crowdsec /var/log/crowdsec* /var/run/crowdsec*</pre>

        <p>
            For testing purposes, you may want to remove the &lt;crowdsec&gt; section
            from <code>/conf/config.xml</code> as well.
        </p>

        <div>
            <a class="btn btn-default btn-info" href="https://github.com/crowdsecurity/crowdsec">
                GitHub
            </a>
            <a class="btn btn-default btn-info" href="https://discourse.crowdsec.net/">
                Discourse
            </a>
            <a class="btn btn-default btn-info" href="https://discord.com/invite/wGN7ShmEE8">
                Discord
            </a>
            <a class="btn btn-default btn-info" href="https://twitter.com/Crowd_Security">
                Twitter
            </a>
        </div>
    </div>
</div>
